<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Email Scraper Web App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6EJx0s6VhpqLFV0ZlW52JXyAN1Nhp8Y20+1p6" crossorigin="anonymous">
    <style>
        :root {
            --bg: #050505;
            --panel: rgba(255, 255, 255, 0.07);
            --panel-border: rgba(255, 255, 255, 0.12);
            --text-primary: #f5f5f5;
            --text-muted: #9d9d9d;
            --divider: rgba(255, 255, 255, 0.08);
            --accent: #ffffff;
            --shadow: 0 36px 60px rgba(0, 0, 0, 0.55);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.92)), var(--bg);
            color: var(--text-primary);
            font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 64px 16px;
        }

        code {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 0.1rem 0.4rem;
            color: var(--text-primary);
        }

        .app-wrapper {
            width: min(960px, 100%);
            display: flex;
            flex-direction: column;
            gap: 48px;
        }

        .app-header {
            text-align: center;
        }

        .app-title {
            font-size: clamp(2rem, 3vw, 2.5rem);
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .app-subtitle {
            color: var(--text-muted);
            max-width: 520px;
            margin: 12px auto 0;
            line-height: 1.6;
        }

        .app-panel {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            border-radius: 28px;
            padding: clamp(28px, 4vw, 48px);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .form-grid {
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-label {
            font-size: 0.7rem;
            letter-spacing: 0.14em;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .form-control {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--panel-border);
            border-radius: 16px;
            padding: 14px 18px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.35);
            box-shadow: none;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.32);
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .checkbox-group {
            justify-content: flex-end;
        }

        .checkbox {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .checkbox input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 1px solid var(--panel-border);
            background: transparent;
            display: grid;
            place-items: center;
            transition: background 0.2s ease, border-color 0.2s ease;
        }

        .checkbox input[type="checkbox"]:checked {
            background: var(--accent);
            border-color: var(--accent);
        }

        .checkbox input[type="checkbox"]:checked::after {
            content: "";
            width: 10px;
            height: 10px;
            background: #000;
            border-radius: 2px;
        }

        .primary-button {
            border: none;
            border-radius: 18px;
            padding: 16px 22px;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            background: var(--accent);
            color: #050505;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(255, 255, 255, 0.14);
        }

        .secondary-button {
            border: 1px solid var(--panel-border);
            border-radius: 18px;
            padding: 12px 18px;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            background: transparent;
            color: var(--text-primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .secondary-button:hover:not(:disabled) {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.32);
            box-shadow: 0 12px 24px rgba(255, 255, 255, 0.1);
        }

        .secondary-button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .notice {
            margin-top: 32px;
            border-radius: 20px;
            padding: 22px 26px;
            border: 1px solid var(--panel-border);
        }

        .notice ul {
            margin: 0;
            padding-left: 18px;
        }

        .notice-error {
            background: rgba(217, 83, 79, 0.15);
            border-color: rgba(217, 83, 79, 0.35);
        }

        .error-summary {
            margin: 0 0 12px;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .error-summary strong {
            color: var(--accent);
        }

        details.error-details {
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.06);
            padding: 12px 16px;
        }

        details.error-details[hidden] {
            display: none;
        }

        details.error-details summary {
            cursor: pointer;
            margin-bottom: 12px;
            font-size: 0.75rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .error-entry {
            display: grid;
            gap: 6px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(217, 83, 79, 0.18);
        }

        .error-entry + .error-entry {
            margin-top: 10px;
        }

        .error-entry code {
            background: rgba(0, 0, 0, 0.2);
        }

        .error-meta {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.68);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .results {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .results-header {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .results-header-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .results-header h2 {
            font-size: 1.1rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .results-header p {
            margin: 0;
            color: var(--text-primary);
        }

        .results-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }

        .result-panel {
            border-radius: 20px;
            border: 1px solid var(--divider);
            background: rgba(255, 255, 255, 0.04);
            padding: 22px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .result-panel h3 {
            margin: 0;
            font-size: 0.85rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .result-panel ul {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            gap: 12px;
            font-family: "Inter", monospace;
            font-size: 0.95rem;
        }

        .result-panel li {
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.06);
        }

        .email-entry {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .email-address {
            flex: 1;
            min-width: 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: inherit;
        }

        .email-address a {
            color: inherit;
        }

        .email-address a,
        .email-address span {
            display: inline-block;
            max-width: 100%;
            word-break: break-all;
        }

        .icon-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 36px;
            width: 36px;
            border-radius: 12px;
            border: 1px solid var(--panel-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }

        .icon-button svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .icon-button:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.28);
        }

        .icon-button:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.45);
            outline-offset: 2px;
        }

        .copy-button.copied {
            background: rgba(60, 179, 113, 0.28);
            border-color: rgba(60, 179, 113, 0.6);
            color: #d8ffe2;
        }

        .copy-button.copy-error {
            background: rgba(217, 83, 79, 0.28);
            border-color: rgba(217, 83, 79, 0.6);
            color: #ffe2e0;
        }

        .result-panel a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            word-break: break-all;
        }

        .result-panel a:hover,
        .result-panel a:focus {
            text-decoration: underline;
        }

        .result-panel .empty-message {
            margin: 0;
            color: var(--text-muted);
        }

        .progress-section {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .progress-row {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .progress-track {
            position: relative;
            flex: 1;
            height: 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.12);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            border-radius: inherit;
            background: var(--accent);
            transition: width 0.4s ease;
        }

        .progress-percent {
            font-weight: 600;
            letter-spacing: 0.12em;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 6px 16px;
            border-radius: 999px;
            font-size: 0.65rem;
            letter-spacing: 0.16em;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-muted);
        }

        .status-pill[data-state="running"] {
            background: var(--accent);
            color: #050505;
        }

        .status-pill[data-state="pending"] {
            background: rgba(255, 255, 255, 0.08);
        }

        .status-pill[data-state="finished"] {
            background: rgba(60, 179, 113, 0.35);
            color: #d8ffe2;
        }

        .status-pill[data-state="failed"] {
            background: rgba(217, 83, 79, 0.35);
            color: #ffe2e0;
        }

        .status-pill[data-state="cancelling"] {
            background: rgba(255, 193, 7, 0.28);
            color: #fff4ce;
        }

        .status-pill[data-state="cancelled"] {
            background: rgba(128, 128, 128, 0.28);
            color: #f1f1f1;
        }

        .job-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .job-meta strong {
            display: block;
            margin-top: 4px;
            color: var(--text-primary);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            body {
                padding: 48px 12px;
            }

            .app-panel {
                border-radius: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <header class="app-header">
            <h1 class="app-title">Email Scraper</h1>
        </header>

        <div class="app-panel">
            <form method="post" novalidate class="form-grid">
                <div class="form-group">
                    <label for="domain" class="form-label">Website domain or URL</label>
                    <input type="text" class="form-control" id="domain" name="domain" placeholder="example.com" value="{{ form_values.domain }}" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="max_pages" class="form-label">Max pages</label>
                        <input type="number" class="form-control" id="max_pages" name="max_pages" value="{{ form_values.max_pages }}" min="1" max="1000">
                    </div>
                    <div class="form-group">
                        <label for="concurrency" class="form-label">Concurrent requests</label>
                        <input type="number" class="form-control" id="concurrency" name="concurrency" value="{{ form_values.concurrency }}" min="1" max="16">
                    </div>
                    <div class="form-group checkbox-group">
                        <label for="allow_external" class="form-label">External domains</label>
                        <label class="checkbox" for="allow_external">
                            <input type="checkbox" id="allow_external" name="allow_external" {% if form_values.allow_external %}checked{% endif %}>
                            <span>Allow traversal outside the root domain</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="exclude" class="form-label">Exclude terms</label>
                    <textarea class="form-control" id="exclude" name="exclude" rows="3" placeholder="collections, product, article">{{ form_values.exclude }}</textarea>
                    <p class="help-text">Separate values with commas or whitespace.</p>
                </div>

                <button type="submit" class="primary-button">Scrape emails</button>
            </form>

            {% if errors %}
                <div class="notice notice-error" role="alert">
                    <ul>
                        {% for error in errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>

        {% set initial_percent = (job.progress_ratio * 100)|round(0, 'floor') if job and job.progress_ratio is not none else 0 %}
        {% set cancel_requested = job.cancel_requested if job and ('cancel_requested' in job) else False %}
        <section id="job-panel" class="results" {% if not job %}hidden{% endif %}>
            <div class="results-header">
                <div class="results-header-row">
                    <div class="status-pill" id="job-status-pill" data-state="{{ job.status if job else 'pending' }}">
                        <span id="job-status-text">
                            {% if job %}
                                {{ job.status|capitalize }}
                            {% else %}
                                Pending
                            {% endif %}
                        </span>
                    </div>
                    <button type="button" class="secondary-button" id="cancel-button"
                        data-job-id="{{ job.id if job else '' }}"
                        {% if not job or job.status in ['finished', 'failed', 'cancelled'] %}hidden{% endif %}
                        {% if cancel_requested or (job and job.status == 'cancelling') %}disabled{% endif %}>
                        {% if cancel_requested or (job and job.status == 'cancelling') %}
                            Cancelling…
                        {% else %}
                            Cancel job
                        {% endif %}
                    </button>
                </div>
                <p id="job-summary">
                    {% if job %}
                        {{ job.processed_count }} / {{ job.max_pages }} pages processed · {{ job.unique_emails }} emails found
                    {% else %}
                        Progress updates will appear here once a job starts.
                    {% endif %}
                </p>
            </div>

            <div class="progress-section">
                <div class="progress-row">
                    <div class="progress-track">
                        <div class="progress-fill" id="progress-fill" data-percent="{{ initial_percent }}"></div>
                    </div>
                    <span class="progress-percent" id="progress-percent">{{ initial_percent }}%</span>
                </div>

                <div class="job-meta">
                    <div>
                        Pages visited
                        <strong id="job-pages">{% if job %}{{ job.processed_count }} / {{ job.max_pages }}{% else %}0 / {{ form_values.max_pages }}{% endif %}</strong>
                    </div>
                    <div>
                        Pages queued
                        <strong id="job-queue">{% if job %}{{ job.queued_count }}{% else %}0{% endif %}</strong>
                    </div>
                    <div>
                        Emails found
                        <strong id="job-total">{% if job %}{{ job.unique_emails }}{% else %}0{% endif %}</strong>
                    </div>
                    <div>
                        Concurrency
                        <strong id="job-concurrency">
                            {% if job and job.form_values %}
                                ×{{ job.form_values.get('concurrency', form_values.concurrency) }}
                            {% else %}
                                ×{{ form_values.concurrency }}
                            {% endif %}
                        </strong>
                    </div>
                    <div>
                        Last fetch
                        <strong id="timing-last-fetch">{% if job and job.timing and job.timing.last_fetch_time is not none %}{{ '%.3f'|format(job.timing.last_fetch_time) }} s{% else %}&mdash;{% endif %}</strong>
                    </div>
                    <div>
                        Last parse
                        <strong id="timing-last-parse">{% if job and job.timing and job.timing.last_parse_time is not none %}{{ '%.3f'|format(job.timing.last_parse_time) }} s{% else %}&mdash;{% endif %}</strong>
                    </div>
                    <div>
                        Avg fetch
                        <strong id="timing-avg-fetch">{% if job and job.timing and job.timing.avg_fetch_time is not none %}{{ '%.3f'|format(job.timing.avg_fetch_time) }} s{% else %}&mdash;{% endif %}</strong>
                    </div>
                    <div>
                        Avg parse
                        <strong id="timing-avg-parse">{% if job and job.timing and job.timing.avg_parse_time is not none %}{{ '%.3f'|format(job.timing.avg_parse_time) }} s{% else %}&mdash;{% endif %}</strong>
                    </div>
                    <div>
                        Slowest fetch
                        <strong id="timing-max-fetch">{% if job and job.timing and job.timing.max_fetch_time is not none %}{{ '%.3f'|format(job.timing.max_fetch_time) }} s{% else %}&mdash;{% endif %}</strong>
                    </div>
                    <div>
                        Slowest parse
                        <strong id="timing-max-parse">{% if job and job.timing and job.timing.max_parse_time is not none %}{{ '%.3f'|format(job.timing.max_parse_time) }} s{% else %}&mdash;{% endif %}</strong>
                    </div>
                </div>

                <p class="help-text" id="job-current-url">
                    {% if job and job.current_url %}
                        Currently visiting <code>{{ job.current_url }}</code>
                    {% elif job %}
                        Waiting for the next page...
                    {% else %}
                        Early results will stream in while the scraper runs.
                    {% endif %}
                </p>
            </div>

            <div id="job-errors" class="notice notice-error" {% if not job or not job.errors %}hidden{% endif %}>
                {% set error_summary = job.error_summary if job else None %}
                <p class="error-summary" id="job-errors-summary">
                    {% if error_summary and error_summary.total %}
                        Encountered <strong>{{ error_summary.total }}</strong> error{{ 's' if error_summary.total != 1 else '' }}
                        across <strong>{{ error_summary.unique }}</strong> issue{{ 's' if error_summary.unique != 1 else '' }}.
                        {% if error_summary.top %}
                            Most common: “{{ error_summary.top.message }}” (×{{ error_summary.top.count }}).
                        {% endif %}
                    {% else %}
                        No errors so far.
                    {% endif %}
                </p>
                <details class="error-details" id="job-errors-details" {% if not job or not job.errors %}hidden{% endif %}>
                    <summary>Show full error log</summary>
                    <ul id="job-errors-list">
                        {% if job and job.errors %}
                            {% for err in job.errors %}
                                <li class="error-entry">
                                    <span class="error-message">{{ err.message }}</span>
                                    {% if err.url %}
                                        <span>URL: <code>{{ err.url }}</code></span>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </details>
            </div>

            <div class="results-grid">
                <div class="result-panel">
                    <h3>Valid emails</h3>
                    <ul id="valid-email-list">
                        {% if job and job.valid_emails %}
                            {% for email in job.valid_emails %}
                                {% set sources = job.email_sources.get(email, []) if job.email_sources else [] %}
                                {% set primary = sources[0] if sources else None %}
                                <li>
                                    {% if primary %}
                                        <a href="{{ primary }}" target="_blank" rel="noopener noreferrer"
                                           title="{% if sources|length > 1 %}Also found on: {{ sources[1:]|join(', ') }}{% else %}{{ primary }}{% endif %}">
                                            {{ email }}
                                        </a>
                                    {% else %}
                                        {{ email }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                    <p class="empty-message" id="valid-empty" {% if job and job.valid_emails %}hidden{% endif %}>No valid emails yet.</p>
                </div>

                <div class="result-panel">
                    <h3>Invalid emails</h3>
                    <ul id="invalid-email-list">
                        {% if job and job.invalid_emails %}
                            {% for email in job.invalid_emails %}
                                {% set sources = job.email_sources.get(email, []) if job.email_sources else [] %}
                                {% set primary = sources[0] if sources else None %}
                                <li>
                                    {% if primary %}
                                        <a href="{{ primary }}" target="_blank" rel="noopener noreferrer"
                                           title="{% if sources|length > 1 %}Also found on: {{ sources[1:]|join(', ') }}{% else %}{{ primary }}{% endif %}">
                                            {{ email }}
                                        </a>
                                    {% else %}
                                        {{ email }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                    <p class="empty-message" id="invalid-empty" {% if job and job.invalid_emails %}hidden{% endif %}>No invalid emails detected.</p>
                </div>
            </div>
        </section>
    </div>

    <script type="application/json" id="initial-job-data">{{ job|tojson }}</script>
    <script>
        (() => {
            const jobDataElement = document.getElementById("initial-job-data");
            if (!jobDataElement) return;

            let jobState = null;
            try {
                jobState = JSON.parse(jobDataElement.textContent);
            } catch (error) {
                jobState = null;
            }

            if (!jobState || !jobState.id) {
                return;
            }

            const panel = document.getElementById("job-panel");
            const statusPill = document.getElementById("job-status-pill");
            const statusText = document.getElementById("job-status-text");
            const summary = document.getElementById("job-summary");
            const progressFill = document.getElementById("progress-fill");
            const progressPercent = document.getElementById("progress-percent");
            const pagesInfo = document.getElementById("job-pages");
            const queueInfo = document.getElementById("job-queue");
            const totalInfo = document.getElementById("job-total");
            const concurrencyInfo = document.getElementById("job-concurrency");
            const currentUrl = document.getElementById("job-current-url");
            const cancelButton = document.getElementById("cancel-button");
            const validList = document.getElementById("valid-email-list");
            const invalidList = document.getElementById("invalid-email-list");
            const validEmpty = document.getElementById("valid-empty");
            const invalidEmpty = document.getElementById("invalid-empty");
            const errorBox = document.getElementById("job-errors");
            const errorList = document.getElementById("job-errors-list");
            const timingLastFetch = document.getElementById("timing-last-fetch");
            const timingLastParse = document.getElementById("timing-last-parse");
            const timingAvgFetch = document.getElementById("timing-avg-fetch");
            const timingAvgParse = document.getElementById("timing-avg-parse");
            const timingMaxFetch = document.getElementById("timing-max-fetch");
            const timingMaxParse = document.getElementById("timing-max-parse");
            const errorSummary = document.getElementById("job-errors-summary");
            const errorDetails = document.getElementById("job-errors-details");
            const copyIconMarkup = '<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z" /></svg>';
            const checkIconMarkup = '<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M20.285 6.707a1 1 0 0 0-1.414-1.414L9 15.164l-3.871-3.879a1 1 0 1 0-1.414 1.414l4.578 4.59a1 1 0 0 0 1.414 0l10.578-10.582Z" /></svg>';
            const errorIconMarkup = '<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M11.001 10h2v5h-2zm0 7h2v2h-2z"/><path d="M21 19H3c-.77 0-1.47-.434-1.813-1.123-.344-.69-.285-1.509.153-2.144l9-13.003c.758-1.096 2.563-1.096 3.32 0l9 13.003c.438.635.497 1.454.153 2.144C22.47 18.566 21.77 19 21 19z"/></svg>';
            const COPY_RESET_DELAY = 2200;
            const ERROR_RESET_DELAY = 2600;

            if (panel) {
                panel.hidden = false;
            }

            const DONE_STATUSES = new Set(["finished", "failed", "cancelled"]);
            const POLL_INTERVAL = 4000;
            let retryDelay = POLL_INTERVAL;
            let cancelRequestInFlight = false;

            const normalizeJobState = (job) => {
                if (!job || typeof job !== "object") {
                    return job;
                }
                if (!job.email_sources || typeof job.email_sources !== "object") {
                    job.email_sources = {};
                }
                if (!job.form_values || typeof job.form_values !== "object") {
                    job.form_values = {};
                }
                return job;
            };

            jobState = normalizeJobState(jobState);

            const updateCancelButton = (job) => {
                if (!cancelButton) {
                    return;
                }
                if (!job) {
                    cancelButton.hidden = true;
                    cancelButton.disabled = true;
                    cancelButton.textContent = "Cancel job";
                    return;
                }
                const disabledStatuses = new Set(["finished", "failed", "cancelled"]);
                if (disabledStatuses.has(job.status)) {
                    cancelButton.hidden = true;
                    cancelButton.disabled = true;
                    cancelButton.textContent = "Cancel job";
                    cancelRequestInFlight = false;
                    return;
                }
                cancelButton.hidden = false;
                const isCancelling = job.status === "cancelling" || job.cancel_requested === true || cancelRequestInFlight;
                cancelButton.disabled = isCancelling;
                cancelButton.textContent = isCancelling ? "Cancelling…" : "Cancel job";
            };

            const triggerCancel = () => {
                if (!cancelButton || !jobState || !jobState.id || cancelRequestInFlight) {
                    return;
                }
                cancelRequestInFlight = true;
                cancelButton.disabled = true;
                cancelButton.textContent = "Cancelling…";
                fetch(`/api/jobs/${jobState.id}/cancel`, {
                    method: "POST",
                    headers: { Accept: "application/json" },
                })
                    .then((response) => response.json().catch(() => ({ status: jobState.status })))
                    .then((data) => {
                        cancelRequestInFlight = false;
                        if (data && typeof data === "object") {
                            jobState = {
                                ...jobState,
                                ...data,
                            };
                            jobState = normalizeJobState(jobState);
                        }
                        if (jobState) {
                            jobState.cancel_requested = true;
                            updateCancelButton(jobState);
                        }
                        setTimeout(poll, 500);
                    })
                    .catch(() => {
                        cancelRequestInFlight = false;
                        cancelButton.disabled = false;
                        cancelButton.textContent = "Cancel job";
                    });
            };

            cancelButton?.addEventListener("click", (event) => {
                event.preventDefault();
                triggerCancel();
            });

            const copyToClipboard = async (value) => {
                if (typeof value !== "string" || !value.trim().length) {
                    throw new Error("Invalid clipboard value");
                }
                if (navigator.clipboard?.writeText) {
                    await navigator.clipboard.writeText(value);
                    return;
                }
                return new Promise((resolve, reject) => {
                    try {
                        const textarea = document.createElement("textarea");
                        textarea.value = value;
                        textarea.setAttribute("readonly", "readonly");
                        textarea.style.position = "fixed";
                        textarea.style.top = "-1000px";
                        document.body.append(textarea);
                        textarea.select();
                        const result = document.execCommand("copy");
                        textarea.remove();
                        if (!result) {
                            reject(new Error("Copy command was rejected"));
                        } else {
                            resolve();
                        }
                    } catch (error) {
                        reject(error instanceof Error ? error : new Error("Copy failed"));
                    }
                });
            };

            const resetCopyButton = (button) => {
                if (!button) return;
                button.classList.remove("copied", "copy-error");
                button.innerHTML = copyIconMarkup;
                const email = button.dataset.email ?? "email";
                button.setAttribute("aria-label", `Copy ${email}`);
            };

            const scheduleReset = (button, delay) => {
                if (!button) return;
                if (button._copyResetTimer) {
                    clearTimeout(button._copyResetTimer);
                }
                button._copyResetTimer = setTimeout(() => {
                    resetCopyButton(button);
                    button._copyResetTimer = null;
                }, delay);
            };

            const handleCopy = (email, button) => {
                if (!button) return;
                const targetEmail = email ?? button.dataset.email;
                if (!targetEmail) return;
                button.dataset.email = targetEmail;
                button.classList.remove("copy-error");
                button.innerHTML = copyIconMarkup;
                button.setAttribute("aria-label", `Copy ${targetEmail}`);
                copyToClipboard(targetEmail)
                    .then(() => {
                        button.classList.add("copied");
                        button.classList.remove("copy-error");
                        button.innerHTML = checkIconMarkup;
                        button.setAttribute("aria-label", `Copied ${targetEmail}`);
                        scheduleReset(button, COPY_RESET_DELAY);
                    })
                    .catch(() => {
                        button.classList.remove("copied");
                        button.classList.add("copy-error");
                        button.innerHTML = errorIconMarkup;
                        button.setAttribute("aria-label", `Copy failed for ${targetEmail}`);
                        scheduleReset(button, ERROR_RESET_DELAY);
                    });
            };

            const formatSeconds = (value) => {
                if (typeof value !== "number" || !Number.isFinite(value) || value < 0) {
                    return null;
                }
                if (value === 0) {
                    return "0 s";
                }
                if (value >= 10) {
                    return `${value.toFixed(1)} s`;
                }
                if (value >= 1) {
                    return `${value.toFixed(2)} s`;
                }
                if (value >= 0.01) {
                    return `${value.toFixed(3)} s`;
                }
                return `${value.toFixed(4)} s`;
            };

            const setTimingValue = (element, value) => {
                if (!element) return;
                const formatted = formatSeconds(value);
                element.textContent = formatted ?? "—";
            };

            const renderEmails = (listEl, emptyEl, emails, job) => {
                if (!listEl || !emptyEl) return;
                listEl.replaceChildren();
                const items = Array.isArray(emails) ? emails : [];
                const emailSources = (job && typeof job === "object" && job.email_sources && typeof job.email_sources === "object")
                    ? job.email_sources
                    : {};
                const fallbackSource = (job && typeof job.source_url === "string") ? job.source_url : null;
                if (items.length) {
                    items.forEach((email) => {
                        const li = document.createElement("li");
                        li.className = "email-entry";

                        const wrapper = document.createElement("span");
                        wrapper.className = "email-address";
                        const sourcesRaw = emailSources[email];
                        const sourceList = Array.isArray(sourcesRaw)
                            ? sourcesRaw.filter((value) => typeof value === "string" && value.trim().length)
                            : [];
                        const uniqueSources = Array.from(new Set(sourceList));
                        let primarySource = uniqueSources[0] ?? null;
                        if (!primarySource && typeof fallbackSource === "string" && fallbackSource.trim().length) {
                            primarySource = fallbackSource;
                        }

                        if (primarySource) {
                            const link = document.createElement("a");
                            link.href = primarySource;
                            link.target = "_blank";
                            link.rel = "noopener noreferrer";
                            link.textContent = email;
                            if (uniqueSources.length > 1) {
                                link.title = `Also found on: ${uniqueSources.slice(1).join(", ")}`;
                            } else {
                                link.title = primarySource;
                            }
                            wrapper.append(link);
                        } else {
                            const textSpan = document.createElement("span");
                            textSpan.textContent = email;
                            wrapper.append(textSpan);
                        }

                        li.append(wrapper);

                        const copyButton = document.createElement("button");
                        copyButton.type = "button";
                        copyButton.className = "icon-button copy-button";
                        copyButton.dataset.email = email;
                        copyButton.setAttribute("aria-label", `Copy ${email}`);
                        copyButton.innerHTML = copyIconMarkup;
                        copyButton.addEventListener("click", () => handleCopy(email, copyButton));
                        li.append(copyButton);

                        listEl.append(li);
                    });
                    listEl.hidden = false;
                    emptyEl.hidden = true;
                } else {
                    listEl.hidden = true;
                    emptyEl.hidden = false;
                }
            };

            const normalizeError = (error) => {
                if (!error) return null;
                if (typeof error === "string") {
                    return {
                        message: error,
                        url: null,
                        timestamp: Date.now() / 1000,
                    };
                }
                if (typeof error === "object") {
                    const message = typeof error.message === "string" && error.message.trim().length
                        ? error.message
                        : JSON.stringify(error);
                    const url = typeof error.url === "string" && error.url.trim().length ? error.url : null;
                    const timestamp = typeof error.timestamp === "number" && Number.isFinite(error.timestamp)
                        ? error.timestamp
                        : Date.now() / 1000;
                    return { message, url, timestamp };
                }
                return null;
            };

            const computeErrorSummary = (errors) => {
                const counter = new Map();
                errors.forEach((err) => {
                    const count = counter.get(err.message) ?? 0;
                    counter.set(err.message, count + 1);
                });
                const byMessage = Array.from(counter.entries())
                    .sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))
                    .map(([message, count]) => ({ message, count }));
                return {
                    total: errors.length,
                    unique: counter.size,
                    top: byMessage.length ? byMessage[0] : null,
                    by_message: byMessage,
                };
            };

            const formatTimestamp = (seconds) => {
                if (typeof seconds !== "number" || !Number.isFinite(seconds)) {
                    return null;
                }
                const date = new Date(seconds * 1000);
                if (Number.isNaN(date.getTime())) {
                    return null;
                }
                return date.toLocaleString();
            };

            const renderErrors = (errors, summary) => {
                if (!errorBox || !errorList || !errorSummary || !errorDetails) return;
                const normalized = Array.isArray(errors)
                    ? errors.map(normalizeError).filter(Boolean)
                    : [];
                errorList.replaceChildren();

                if (!normalized.length) {
                    errorBox.hidden = true;
                    errorDetails.hidden = true;
                    errorSummary.textContent = "No errors so far.";
                    return;
                }

                errorBox.hidden = false;
                errorDetails.hidden = false;

                const summaryData = (summary && typeof summary === "object")
                    ? summary
                    : computeErrorSummary(normalized);

                let summaryText = "No errors so far.";
                if (summaryData.total) {
                    summaryText = `Encountered ${summaryData.total} error${summaryData.total === 1 ? "" : "s"}`
                        + ` across ${summaryData.unique} issue${summaryData.unique === 1 ? "" : "s"}.`;
                    if (summaryData.top && summaryData.top.message) {
                        summaryText += ` Most common: “${summaryData.top.message}” (×${summaryData.top.count}).`;
                    }
                }
                errorSummary.textContent = summaryText;

                normalized.forEach((err) => {
                    const li = document.createElement("li");
                    li.className = "error-entry";

                    const messageSpan = document.createElement("span");
                    messageSpan.className = "error-message";
                    messageSpan.textContent = err.message;
                    li.append(messageSpan);

                    if (err.url) {
                        const urlSpan = document.createElement("span");
                        urlSpan.textContent = "URL: ";
                        const urlCode = document.createElement("code");
                        urlCode.textContent = err.url;
                        urlSpan.append(urlCode);
                        li.append(urlSpan);
                    }

                    const timestampLabel = formatTimestamp(err.timestamp);
                    if (timestampLabel) {
                        const metaSpan = document.createElement("span");
                        metaSpan.className = "error-meta";
                        metaSpan.textContent = `Logged at ${timestampLabel}`;
                        li.append(metaSpan);
                    }

                    errorList.append(li);
                });
            };

            const formatStatus = (status) => {
                switch (status) {
                    case "finished":
                        return "Completed";
                    case "failed":
                        return "Failed";
                    case "cancelled":
                        return "Cancelled";
                    case "cancelling":
                        return "Cancelling…";
                    case "running":
                        return "Running";
                    case "pending":
                    default:
                        return status ? status.charAt(0).toUpperCase() + status.slice(1) : "Pending";
                }
            };

            const render = (job) => {
                const status = job.status || "pending";
                if (statusPill) {
                    statusPill.dataset.state = status;
                }
                if (statusText) {
                    statusText.textContent = formatStatus(status);
                }

                const processed = job.processed_count ?? 0;
                const maxPages = job.max_pages ?? 0;
                const totalEmails = job.unique_emails ?? 0;
                const rawConcurrency = Number.isFinite(job.concurrency)
                    ? job.concurrency
                    : Number.parseInt(job.form_values?.concurrency, 10);
                const concurrencyValue = Number.isFinite(rawConcurrency) && rawConcurrency > 0
                    ? rawConcurrency
                    : 1;
                const ratio = typeof job.progress_ratio === "number" && Number.isFinite(job.progress_ratio)
                    ? Math.max(0, Math.min(1, job.progress_ratio))
                    : (maxPages > 0 ? Math.max(0, Math.min(1, processed / maxPages)) : 0);
                const percent = Math.round(ratio * 100);

                if (progressFill) {
                    progressFill.style.width = `${percent}%`;
                    progressFill.dataset.percent = String(percent);
                }
                if (progressPercent) {
                    progressPercent.textContent = `${percent}%`;
                }
                if (summary) {
                    summary.textContent = `${processed} / ${maxPages} pages processed · ${totalEmails} emails found`;
                }
                if (pagesInfo) {
                    pagesInfo.textContent = `${processed} / ${maxPages}`;
                }
                if (queueInfo) {
                    queueInfo.textContent = `${job.queued_count ?? 0}`;
                }
                if (totalInfo) {
                    totalInfo.textContent = `${totalEmails}`;
                }
                if (concurrencyInfo) {
                    concurrencyInfo.textContent = `×${concurrencyValue}`;
                }
                const timing = job.timing ?? {};
                setTimingValue(timingLastFetch, timing.last_fetch_time);
                setTimingValue(timingLastParse, timing.last_parse_time);
                setTimingValue(timingAvgFetch, timing.avg_fetch_time);
                setTimingValue(timingAvgParse, timing.avg_parse_time);
                setTimingValue(timingMaxFetch, timing.max_fetch_time);
                setTimingValue(timingMaxParse, timing.max_parse_time);
                if (currentUrl) {
                    if (job.current_url) {
                        const code = document.createElement("code");
                        code.textContent = job.current_url;
                        currentUrl.replaceChildren("Currently visiting ", code);
                    } else if (status === "finished") {
                        currentUrl.textContent = "Scrape completed.";
                        } else if (status === "failed") {
                        currentUrl.textContent = "Scrape halted.";
                        } else if (status === "cancelled") {
                            currentUrl.textContent = "Scrape cancelled.";
                        } else if (status === "cancelling") {
                            currentUrl.textContent = "Cancelling…";
                    } else {
                        currentUrl.textContent = "Waiting for the next page...";
                    }
                }

                renderEmails(validList, validEmpty, job.valid_emails, job);
                renderEmails(invalidList, invalidEmpty, job.invalid_emails, job);
                renderErrors(job.errors, job.error_summary);
                updateCancelButton(job);
            };

            const poll = () => {
                fetch(`/api/jobs/${jobState.id}?_=${Date.now()}`, { headers: { Accept: "application/json" } })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(`Server responded with ${response.status}`);
                        }
                        return response.json();
                    })
                    .then((data) => {
                        jobState = normalizeJobState(data);
                        render(jobState);
                        if (DONE_STATUSES.has(jobState.status)) {
                            return;
                        }
                        retryDelay = POLL_INTERVAL;
                        setTimeout(poll, POLL_INTERVAL);
                    })
                    .catch((error) => {
                        const fallbackErrors = Array.isArray(jobState?.errors)
                            ? jobState.errors.slice()
                            : [];
                        fallbackErrors.push({
                            message: `Progress update failed: ${error.message}`,
                            timestamp: Date.now() / 1000,
                        });
                        renderErrors(fallbackErrors, jobState?.error_summary);
                        retryDelay = Math.min(retryDelay * 1.5, 20000);
                        setTimeout(poll, retryDelay);
                    });
            };

            render(jobState);

            if (!DONE_STATUSES.has(jobState.status)) {
                setTimeout(poll, POLL_INTERVAL);
            }
        })();
    </script>
</body>
</html>
